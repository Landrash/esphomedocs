<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><meta http-equiv="X-UA-Compatible"content="IE=Edge"><meta http-equiv="Content-Type"content="text/html; charset=utf-8"><title>MQTT Client Component &#8212; esphomelib 1.5.3 documentation</title><link rel="stylesheet"href="../../_static/alabaster.css"type="text/css"><link rel="stylesheet"href="../../_static/pygments.css"type="text/css"><script src="../../_static/documentation_options.js"></script><script src="../../_static/jquery.js"></script><script src="../../_static/underscore.js"></script><script src="../../_static/doctools.js"></script><link rel="index"title="Index"href="../../genindex.html"><link rel="search"title="Search"href="../../search.html"><link rel="stylesheet"href="../../_static/custom.css"type="text/css"><meta name="viewport"content="width=device-width,initial-scale=0.9,maximum-scale=0.9"><div class="document"><div class="documentwrapper"><div class="bodywrapper"><div class="body"role="main"><div class="section"id="mqtt-client-component"><h1>MQTT Client Component<a class="headerlink"href="#mqtt-client-component"title="Permalink to this headline">¬∂</a></h1><p>The MQTT Client Component sets up the MQTT connection to your broker and is currently required for esphomelib to work. In most cases, you will just be able to copy over the <a class="reference external"href="https://www.home-assistant.io/components/mqtt/">MQTT section</a> of your Home Assistant configuration.<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example configuration entry</span>
<span class="n">mqtt</span><span class="p">:</span>
  <span class="n">broker</span><span class="p">:</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span>
  <span class="n">username</span><span class="p">:</span> <span class="n">livingroom</span>
  <span class="n">password</span><span class="p">:</span> <span class="n">MyMQTTPassword</span>
</pre></div></div><div class="section"id="configuration-variables"><h2>Configuration variables:<a class="headerlink"href="#configuration-variables"title="Permalink to this headline">¬∂</a></h2><ul class="simple"><li><strong>broker</strong> (<strong>Required</strong>, string): The host of your MQTT broker.<li><strong>port</strong> (<em>Optional</em>, int): The port to connect to. Defaults to 1883.<li><strong>username</strong> (<em>Optional</em>, string): The username to use for authentication. Empty (the default) means no authentication.<li><strong>password</strong> (<em>Optional</em>, string): The password to use for authentication. Empty (the default) means no authentication.<li><strong>client_id</strong> (<em>Optional</em>, string): The client id to use for opening connections. See <a class="reference external"href="#defaults">Defaults</a> for more information.<li><strong>discovery</strong> (<em>Optional</em>, boolean): If Home Assistant automatic discovery should be enabled. Defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>.<li><strong>discovery_retain</strong> (<em>Optional</em>, boolean): Whether to retain MQTT discovery messages so that entities are added automatically on Home Assistant restart. Defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>.<li><strong>discovery_prefix</strong> (<em>Optional</em>, string): The prefix to use for Home Assistant‚Äôs MQTT discovery. Should not contain trailing slash. Defaults to <code class="docutils literal notranslate"><span class="pre">homeassistant</span></code>.<li><strong>topic_prefix</strong> (<em>Optional</em>, string): The prefix used for all MQTT messages. Should not contain trailing slash. Defaults to <code class="docutils literal notranslate"><span class="pre">&lt;APP_NAME&gt;</span></code>.<li><strong>log_topic</strong> (<em>Optional</em>, <a class="reference external"href="#mqttmessage">MQTTMessage</a>) The topic to send MQTT log messages to.<li><strong>birth_message</strong> (<em>Optional</em>, <a class="reference external"href="#mqttmessage">MQTTMessage</a>): The message to send when a connection to the broker is established. See <a class="reference external"href="#last-will-and-birth-messages">Last Will And Birth Messages</a> for more information.<li><strong>will_message</strong> (<em>Optional</em>, <a class="reference external"href="#mqttmessage">MQTTMessage</a>): The message to send when the MQTT connection is dropped. See <a class="reference external"href="#last-will-and-birth-messages">Last Will And Birth Messages</a> for more information.<li><strong>ssl_fingerprints</strong> (<em>Optional</em>, list): Only on ESP8266. A list of SHA1 hashes used for verifying SSL connections. See <a class="reference external"href="#ssl-fingerprints">SSL Fingerprints</a> for more information.<li><strong>keepalive</strong> (<em>Optional</em>, <a class="reference external"href="/esphomeyaml/configuration-types.html#time">time</a>): The time to keep the MQTT socket alive, decreasing this can help with overall stability due to more WiFi traffic with more pings. Defaults to 15 seconds.<li><strong>id</strong> (<em>Optional</em>, <a class="reference external"href="/esphomeyaml/configuration-types.html#id">id</a>): Manually specify the ID used for code generation.</ul></div><div class="section"id="mqttmessage"><h2>MQTTMessage<a class="headerlink"href="#mqttmessage"title="Permalink to this headline">¬∂</a></h2><p>With the MQTT Message schema you can tell esphomeyaml how a specific MQTT message should be sent. It is used in several places like last will and birth messages or MQTT log options.<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple:</span>
<span class="n">some_option</span><span class="p">:</span> <span class="n">topic</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">send</span><span class="o">/</span><span class="n">to</span>

<span class="c1"># Disable:</span>
<span class="n">some_option</span><span class="p">:</span>

<span class="c1"># Advanced:</span>
<span class="n">some_option</span><span class="p">:</span>
  <span class="n">topic</span><span class="p">:</span> <span class="n">topic</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">send</span><span class="o">/</span><span class="n">to</span>
  <span class="n">payload</span><span class="p">:</span> <span class="n">online</span>
  <span class="n">qos</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">retain</span><span class="p">:</span> <span class="kc">True</span>
</pre></div></div><p>Configuration options:<ul class="simple"><li><strong>topic</strong> (<em>Required</em>, string): The MQTT topic to publish the message.<li><strong>payload</strong> (<em>Required</em>, string): The message content. Will be filled by the actual payload with some options, like log_topic.<li><strong>qos</strong> (<em>Optional</em>, int): The <a class="reference external"href="https://www.hivemq.com/blog/mqtt-essentials-part-6-mqtt-quality-of-service-levels">Quality of Service</a> level of the topic. Defaults to 0.<li><strong>retain</strong> (<em>Optional</em>, boolean): If the published message should have a retain flag on or not. Defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</ul></div><div class="section"id="using-with-home-assistant"><h2>Using with Home Assistant<a class="headerlink"href="#using-with-home-assistant"title="Permalink to this headline">¬∂</a></h2><p>Using esphomelib with Home Assistant is easy, simply setup an MQTT broker (like <a class="reference external"href="https://mosquitto.org/">mosquitto</a>) and point both your Home Assistant installation and esphomelib to that broker. Next, enable discovery in your Home Assistant configuration with the following:<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example Home Assistant configuration.yaml entry</span>
<span class="n">mqtt</span><span class="p">:</span>
  <span class="n">broker</span><span class="p">:</span> <span class="o">...</span>
  <span class="n">discovery</span><span class="p">:</span> <span class="kc">True</span>
</pre></div></div><p>And that should already be it üéâ All devices defined through esphomelib/esphomeyaml should show up automatically in the entities section of Home Assistant.<p>When adding new entities, you might run into trouble with old entities still appearing in Home Assistant‚Äôs front-end. This is because in order to have Home Assistant ‚Äúdiscover‚Äù your devices on restart, all discovery MQTT messages need to be retained. Therefore the old entities will also re-appear on every Home Assistant restart even though they‚Äôre in eshomeyaml anymore.<p>To fix this, esphomeyaml has a simple helper script that purges stale retained messages for you:<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esphomeyaml</span> <span class="n">configuration</span><span class="o">.</span><span class="n">yaml</span> <span class="n">clean</span><span class="o">-</span><span class="n">mqtt</span>
</pre></div></div><p>This will remove all retained messages with the topic <code class="docutils literal notranslate"><span class="pre">&lt;DISCOVERY_PREFIX&gt;/+/NODE_NAME/#</span></code>. If you want to purge on another topic, simply add <code class="docutils literal notranslate"><span class="pre">--topic</span> <span class="pre">&lt;your_topic&gt;</span></code> to the command.</div><div class="section"id="defaults"><h2>Defaults<a class="headerlink"href="#defaults"title="Permalink to this headline">¬∂</a></h2><p>By default, esphomelib will prefix all messages with your node name or <code class="docutils literal notranslate"><span class="pre">topic_prefix</span></code> if you have specified it manually. The client id will automatically be generated by using your node name and adding the MAC address of your device to it. Next, discovery is enabled by default with Home Assistant‚Äôs default prefix <code class="docutils literal notranslate"><span class="pre">homeassistant</span></code>.<p>If you want to prefix all MQTT messages with a different prefix, like <code class="docutils literal notranslate"><span class="pre">home/living_room</span></code>, you can specify a custom <code class="docutils literal notranslate"><span class="pre">topic_prefix</span></code> in the configuration. That way, you can use your existing wildcards like <code class="docutils literal notranslate"><span class="pre">home/+/#</span></code> together with esphomelib. All other features of esphomelib (like availabilty) should still work correctly.</div><div class="section"id="last-will-and-birth-messages"><h2>Last Will And Birth Messages<a class="headerlink"href="#last-will-and-birth-messages"title="Permalink to this headline">¬∂</a></h2><p>esphomelib (and esphomeyaml) uses the <a class="reference external"href="https://www.hivemq.com/blog/mqtt-essentials-part-9-last-will-and-testament">last will testament</a> and birth message feature of MQTT to achieve availabilty reporting for Home Assistant. If the node is not connected to MQTT, Home Assistant will show all its entities as unavailable (a feature üòâ).<p><a class="align-center reference internal"href="../../_images/mqtt-availability.png"><img alt="image0"class="align-center"src="../../_images/mqtt-availability.png"style="width: 50.0%;"></a><p>By default, esphomelib will send a retained MQTT message to <code class="docutils literal notranslate"><span class="pre">&lt;TOPIC_PREFIX&gt;/status</span></code> with payload <code class="docutils literal notranslate"><span class="pre">online</span></code>, and will tell the broker to send a message <code class="docutils literal notranslate"><span class="pre">&lt;TOPIC_PREFIX&gt;/status</span></code> with payload <code class="docutils literal notranslate"><span class="pre">offline</span></code> if the connection drops.<p>You can change these messages by overriding the <code class="docutils literal notranslate"><span class="pre">birth_message</span></code> and <code class="docutils literal notranslate"><span class="pre">will_message</span></code> with the following options.<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="p">:</span>
  <span class="c1"># ...</span>
  <span class="n">birth_message</span><span class="p">:</span>
    <span class="n">topic</span><span class="p">:</span> <span class="n">myavailability</span><span class="o">/</span><span class="n">topic</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">online</span>
  <span class="n">will_message</span><span class="p">:</span>
    <span class="n">topic</span><span class="p">:</span> <span class="n">myavailability</span><span class="o">/</span><span class="n">topic</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">offline</span>
</pre></div></div><ul class="simple"><li><strong>birth_message</strong> (<em>Optional</em>, <a class="reference external"href="#mqttmessage">MQTTMessage</a>)<li><strong>will_message</strong> (<em>Optional</em>, <a class="reference external"href="#mqttmessage">MQTTMessage</a>)</ul><p>If the birth message and last will message have empty topics or topics that are different from each other, availabilty reporting will be disabled.</div><div class="section"id="ssl-fingerprints"><h2>SSL Fingerprints<a class="headerlink"href="#ssl-fingerprints"title="Permalink to this headline">¬∂</a></h2><p>On the ESP8266 you have the option to use SSL connections for MQTT. This feature will get expanded to the ESP32 once the base library, AsyncTCP, supports it. Please note that the SSL feature only checks the SHA1 hash of the SSL certificate to verify the integrity of the connection, so every time the certificate changes, you‚Äôll have to update the fingerprints variable. Additionally, SHA1 is known to be partially insecure and with some computing power the fingerprint can be faked.<p>To get this fingerprint, first put the broker and port options in the configuration and then run the <code class="docutils literal notranslate"><span class="pre">mqtt-fingerprint</span></code> script of esphomeyaml to get the certificate:<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esphomeyaml</span> <span class="n">livingroom</span><span class="o">.</span><span class="n">yaml</span> <span class="n">mqtt</span><span class="o">-</span><span class="n">fingerprint</span>
<span class="o">&gt;</span> <span class="n">SHA1</span> <span class="n">Fingerprint</span><span class="p">:</span> <span class="n">a502ff13999f8b398ef1834f1123650b3236fc07</span>
<span class="o">&gt;</span> <span class="n">Copy</span> <span class="n">above</span> <span class="n">string</span> <span class="n">into</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">ssl_fingerprints</span> <span class="n">section</span> <span class="n">of</span> <span class="n">livingroom</span><span class="o">.</span><span class="n">yaml</span>
</pre></div></div><div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mqtt</span><span class="p">:</span>
  <span class="c1"># ...</span>
  <span class="n">ssl_fingerprints</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">a502ff13999f8b398ef1834f1123650b3236fc07</span>
</pre></div></div></div><div class="section"id="mqtt-component-base-configuration"><h2>MQTT Component Base Configuration<a class="headerlink"href="#mqtt-component-base-configuration"title="Permalink to this headline">¬∂</a></h2><p>All components in esphomelib that do some sort of communication through MQTT can have some overrides for specific options.<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Component Name&quot;</span>
<span class="c1"># Optional variables:</span>
<span class="n">retain</span><span class="p">:</span> <span class="kc">True</span>
<span class="n">discovery</span><span class="p">:</span> <span class="kc">True</span>
<span class="n">availabilty</span><span class="p">:</span>
  <span class="n">topic</span><span class="p">:</span> <span class="n">livingroom</span><span class="o">/</span><span class="n">status</span>
  <span class="n">payload_available</span><span class="p">:</span> <span class="n">online</span>
  <span class="n">payload_not_available</span><span class="p">:</span> <span class="n">offline</span>
<span class="n">state_topic</span><span class="p">:</span> <span class="n">livingroom</span><span class="o">/</span><span class="n">custom_state_topic</span>
<span class="n">command_topic</span><span class="p">:</span> <span class="n">livingroom</span><span class="o">/</span><span class="n">custom_command_topic</span>
</pre></div></div><p>Configuration variables:<ul class="simple"><li><strong>name</strong> (<strong>Required</strong>, string): The name to use for the MQTT Component.<li><strong>retain</strong> (<em>Optional</em>, boolean): If all MQTT state messages should be retained. Defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code>.<li><strong>discovery</strong> (<em>Optional</em>, boolean): Manually enable/disable discovery for a component. Defaults to the global default.<li><strong>availabilty</strong> (<em>Optional</em>): Manually set what should be sent to Home Assistant for showing entity availabilty. Default derived from <a class="reference external"href="#last-will-and-birth-messages">global birth/last will message</a>.<li><strong>state_topic</strong> (<em>Optional</em>, string): The topic to publish state updates to. Defaults to <code class="docutils literal notranslate"><span class="pre">&lt;TOPIC_PREFIX&gt;/&lt;COMPONENT_TYPE&gt;/&lt;COMPONENT_NAME&gt;/state</span></code> (non-alphanumeric characters from the name are removed).<li><strong>command_topic</strong> (<em>Optional</em>, string): The topic to subscribe to for commands from the remote. Defaults to <code class="docutils literal notranslate"><span class="pre">&lt;TOPIC_PREFIX&gt;/&lt;COMPONENT_TYPE&gt;/&lt;COMPONENT_NAME&gt;/command</span></code> (non-alphanumeric characters from the name are removed).</ul></div></div></div></div></div><div class="sphinxsidebar"role="navigation"aria-label="main navigation"><div class="sphinxsidebarwrapper"><div class="relations"><h3>Related Topics</h3><ul><li><a href="../../index.html">Documentation overview</a><ul></ul></ul></div><div id="searchbox"style="display: none"role="search"><h3>Quick search</h3><div class="searchformwrapper"><form class="search"action="../../search.html"><input name="q"> <input type="submit"value="Go"> <input type="hidden"name="check_keywords"value="yes"> <input type="hidden"name="area"value="default"></form></div></div><script>$('#searchbox').show(0);</script></div></div><div class="clearer"></div></div><div class="footer">&copy;2018, Otto Winter. | Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.2</a> &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a> | <a href="../../_sources/esphomeyaml/components/mqtt.rst.txt"rel="nofollow">Page source</a></div>